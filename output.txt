


=================== UMA prototype flow ======================

This flow defines the retrieval by a doctor of this resource.

The patient has synced some data with his pod at http://localhost:3000/ruben/medical/smartwatch.ttl

To protect this data, a policy is added restricting access to a specific healthcare employee for the purpose of bariatric care

Note: policy management is out of scope for POC1

Set the following policy:



PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX eu-gdpr: <https://w3id.org/dpv/legal/eu/gdpr#>
PREFIX oac: <https://w3id.org/oac#>
PREFIX odrl: <http://www.w3.org/ns/odrl/2/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

PREFIX ex: <http://example.org/>

<http://example.org/HCPX-request> a odrl:Request ;
    odrl:uid ex:HCPX-request ;
    odrl:profile oac: ;
    dcterms:description "HCP X requests to read Alice's health data for bariatric care.";
    odrl:permission <http://example.org/HCPX-request-permission> .

<http://example.org/HCPX-request-permission> a odrl:Permission ;
    odrl:action odrl:read ;
    odrl:target <http://localhost:3000/ruben/medical/smartwatch.ttl> ;
    odrl:assigner <http://localhost:3000/ruben/profile/card#me> ;
    odrl:assignee <http://localhost:3000/alice/profile/card#me> ;
    odrl:constraint <http://example.org/HCPX-request-permission-purpose>,
        <http://example.org/HCPX-request-permission-lb> .

<http://example.org/HCPX-request-permission-purpose> a odrl:Constraint ;
    odrl:leftOperand odrl:purpose ; # can also be oac:Purpose, to conform with OAC profile
    odrl:operator odrl:eq ;
    odrl:rightOperand ex:bariatric-care .

<http://example.org/HCPX-request-permission-lb> a odrl:Constraint ;
    odrl:leftOperand oac:LegalBasis ;
    odrl:operator odrl:eq ;
    odrl:rightOperand eu-gdpr:A9-2-a .

----------------------------------------------------

This policy assigns access to the person's house doctor http://localhost:3000/alice/profile/card#me for the smartwatch resource, 
requiring the purpose of the request to equal "http://example.org/bariatric-care"
and the legal basis to equal "https://w3id.org/dpv/legal/eu/gdpr#A9-2-a"

The house doctor in question now wants to access the private user resource.

First the doctor sends a ticket request to the authorization server (shortcut routine)


{
  '@context': 'http://www.w3.org/ns/odrl.jsonld',
  '@type': 'Request',
  profile: { '@id': 'https://w3id.org/oac#' },
  uid: 'http://example.org/HCPX-request/48634506-29db-41d8-a0b8-ca29b8e747e4',
  description: "HCP X requests to read Alice's health data for bariatric care.",
  permission: {
    '@type': 'Permission',
    '@id': 'http://example.org/HCPX-request-permission/783e8106-0082-43f7-b2cc-345703039844',
    target: 'http://localhost:3000/ruben/medical/smartwatch.ttl',
    action: { '@id': 'https://w3id.org/oac#read' }
  }
}

Based on the policy, the UMA server requests the following claims from the agent:

  - urn:solidlab:uma:claims:types:webid

  - http://www.w3.org/ns/odrl/2/purpose

  - https://w3id.org/oac#LegalBasis

accompanied by a ticket for the interaction: e55bbbba-76a0-4e6c-b6ae-6f70b4e6d0ab.

The agent gathers the necessary claims (the manner in which is out-of-scope for this demo)


{
  'http://www.w3.org/ns/odrl/2/purpose': 'http://example.org/bariatric-care',
  'urn:solidlab:uma:claims:types:webid': 'http://localhost:3000/alice/profile/card#me',
  'https://w3id.org/oac#LegalBasis': 'https://w3id.org/dpv/legal/eu/gdpr#A9-2-a'
}

and bundles them as an UMA-compliant JWT.


{
  claim_token: 'eyJhbGciOiJIUzI1NiJ9.eyJodHRwOi8vd3d3LnczLm9yZy9ucy9vZHJsLzIvcHVycG9zZSI6Imh0dHA6Ly9leGFtcGxlLm9yZy9iYXJpYXRyaWMtY2FyZSIsInVybjpzb2xpZGxhYjp1bWE6Y2xhaW1zOnR5cGVzOndlYmlkIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FsaWNlL3Byb2ZpbGUvY2FyZCNtZSIsImh0dHBzOi8vdzNpZC5vcmcvb2FjI0xlZ2FsQmFzaXMiOiJodHRwczovL3czaWQub3JnL2Rwdi9sZWdhbC9ldS9nZHByI0E5LTItYSJ9.nT55jaXNDsHgAo_zcRMsbJqcNj4FVdW_-xjcwNam-1M',
  claim_token_format: 'urn:solidlab:uma:claims:formats:jwt'
}

Together with the UMA grant_type and ticket requirements, these are bundled as an ODRL Request and sent back to the Authorization Server


{
  '@context': 'http://www.w3.org/ns/odrl.jsonld',
  '@type': 'Request',
  profile: { '@id': 'https://w3id.org/oac#' },
  uid: 'http://example.org/HCPX-request/63d70e32-e73d-428a-afd3-1efef9039113',
  description: "HCP X requests to read Alice's health data for bariatric care.",
  permission: {
    '@type': 'Permission',
    '@id': 'http://example.org/HCPX-request-permission/325c98c6-1f59-48b1-b8f0-5347b9e09b0c',
    target: 'http://localhost:3000/ruben/medical/smartwatch.ttl',
    action: { '@id': 'https://w3id.org/oac#read' },
    constraint: [ [Object], [Object] ]
  },
  claim_token: 'eyJhbGciOiJIUzI1NiJ9.eyJodHRwOi8vd3d3LnczLm9yZy9ucy9vZHJsLzIvcHVycG9zZSI6Imh0dHA6Ly9leGFtcGxlLm9yZy9iYXJpYXRyaWMtY2FyZSIsInVybjpzb2xpZGxhYjp1bWE6Y2xhaW1zOnR5cGVzOndlYmlkIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FsaWNlL3Byb2ZpbGUvY2FyZCNtZSIsImh0dHBzOi8vdzNpZC5vcmcvb2FjI0xlZ2FsQmFzaXMiOiJodHRwczovL3czaWQub3JnL2Rwdi9sZWdhbC9ldS9nZHByI0E5LTItYSJ9.nT55jaXNDsHgAo_zcRMsbJqcNj4FVdW_-xjcwNam-1M',
  claim_token_format: 'urn:solidlab:uma:claims:formats:jwt',
  grant_type: 'urn:ietf:params:oauth:grant-type:uma-ticket',
  ticket: 'e55bbbba-76a0-4e6c-b6ae-6f70b4e6d0ab'
}

Note that the ODRL constraints are not yet processed as claims, only the ODRL claim_token(_format) flow.

The UMA server checks the claims with the relevant policy, and returns the agent an access token with the requested permissions.


[
  {
    "resource_id": "http://localhost:3000/ruben/medical/smartwatch.ttl",
    "resource_scopes": [
      "urn:example:css:modes:read"
    ]
  }
]

and the accompanying agreement:


{
  "@context": "http://www.w3.org/ns/odrl.jsonld",
  "@type": "Agreement",
  "uid": "urn:uma:pacsoi:agreement:5f63659d-9bb5-46e9-b718-67f30c319ae0",
  "http://purl.org/dc/terms/description": "Agreement for HCP X to read Alice's health data for bariatric care.",
  "https://w3id.org/dpv#hasLegalBasis": {
    "@id": "https://w3id.org/dpv/legal/eu/gdpr#eu-gdpr:A9-2-a"
  },
  "permission": {
    "@type": "Permission",
    "action": "https://w3id.org/oac#read",
    "target": "http://localhost:3000/ruben/medical/smartwatch.ttl",
    "assigner": "http://localhost:3000/ruben/profile/card#me",
    "assignee": "http://localhost:3000/alice/profile/card#me",
    "constraint": {
      "@type": "Constraint",
      "leftOperand": "purpose",
      "operator": "eq",
      "rightOperand": {
        "@id": "http://example.org/bariatric-care"
      }
    }
  }
}

Now the doctor can retrieve the resource:


<this> <is> <smartwatch> <data>.
